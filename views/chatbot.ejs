<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css">
    <title>ChatBot SOC</title>
</head>

<body>
    <div class="container">
        <header><%- include('partials/header') %></header>
        
        <ul class="messages-list">
            <% chats.forEach(chat=> { 
                %> <% if (chat.user==='user' ) { %>
                    <li class="message">
                        <div class="avatar img-custom">
                            <img src="/images/user-avatar.png" width="30px" />
                        </div>
                        <div class="text sent">
                            <div class="message-sender">
                                <b>You</b>
                            </div>
                            <div class="message-content">
                                <%= chat.message %>
                            </div>
                        </div>
                    </li>
                    <% } 
                    
                    else { %>
                        <li class="message">
                            <div class="avatar img-custom">
                                <img src="/images/aichatbot-avatar-2.png" width="30px" />
                            </div>
                            <div class="text received">
                                <div class="message-receiver">
                                    <b>AI Chatbot</b>
                                </div>
                                <div class="message-content">
                                    <%= chat.message %>
                                </div>
                            </div>
                        </li>
                        <% } %>
            <% }); %>
        </ul>
        
        <form class="message-form expanded" method="POST" enctype="multipart/form-data">
            <ul class="file-container"></ul>
            <div class="input-group">
                <textarea type="text" class="form-control message-input img-custom" id="messageInput" name="message" rows="1"
                    placeholder="Type message..."></textarea>
                <label class="btn-upload img-custom" for="pdfFileInput">
                    <img src="/images/file.png" width="25px" />
                    <input type="file" class="file-input" id="pdfFileInput" name="file" accept="application/pdf" />
                </label>
                <button type="submit" class="btn-send img-custom" id="sendMessage">
                    <img src="/images/send.png" width="25px" />
                </button>
            </div>
        </form>

        <footer><%- include('partials/footer') %></footer>
    </div>

    <script>
        function autoResizeMessageInput(event) {
            event.style.height = "1.8rem";
            let newHeight = event.scrollHeight;

            const lineHeight = parseFloat(getComputedStyle(event).lineHeight);
            const maxHeight = lineHeight * 4;

            if (newHeight > maxHeight) newHeight = maxHeight;
            event.style.height = newHeight + "px";
        }

        function unselectedFile(event) {
            const fileItem = event.target.closest('li');
            const fileNameContainer = document.querySelector(".file-container");

            if (fileItem) {
                fileItem.remove();
            }

            const pdfFileInput = document.getElementById("pdfFileInput");
            if (pdfFileInput) {
                pdfFileInput.value = "";
            }

            if (fileNameContainer && fileNameContainer.children.length === 0) {
                fileNameContainer.innerHTML = ''; 
            }
        }


        document.addEventListener("DOMContentLoaded", function() {
            const messagesList = document.querySelector(".messages-list");
            const messageForm = document.querySelector(".message-form");
            const fileNameContainer = document.querySelector(".file-container");

            const messageInput = document.getElementById("messageInput");
            const pdfFileInput = document.getElementById("pdfFileInput");
            const sendButton = document.getElementById("sendMessage");

            // Ensure all elements are available before adding event listeners
            if (messageInput && messageForm && pdfFileInput && sendButton) {

                const maxWords = 500;
                const maxChars = 500;
                const lineHeight = 20;
                const maxHeight = lineHeight * 5;

                window.addEventListener('resize', function(event) {
                    event.preventDefault();
                    autoResizeMessageInput(messageInput);
                });

                pdfFileInput.addEventListener("change", (event) => {
                    event.preventDefault();
                    const selectedFile = event.target.files[0];
                    const fileName = selectedFile.name;

                    if (selectedFile) {
                        fileNameContainer.innerHTML = `
                            <li class="file" >
                                <div class="file-name">${fileName}</div>
                                <div class="img-custom">
                                    <img src="/images/unselected.png" style="margin-top: 10px; margin-left: 3px; margin-right: 3px" width="25px" onclick="unselectedFile(event)"/>
                                </div>
                            </li>
                        `;
                    } else {
                        fileNameContainer.innerHTML = ``;
                    }
                });
                
                messageInput.setAttribute('maxlength', maxChars);

                messageInput.addEventListener('input', function(event) {
                    event.preventDefault();
                    autoResizeMessageInput(messageInput);
                    const words = messageInput.value.trim().split(/\s+/);

                    if (words.length > maxWords) {
                        const trimmedText = words.slice(0, maxWords).join(" ");
                        messageInput.value = trimmedText;
                        alert(`You have reached the maximum word limit of ${maxWords}.`);
                    }

                    if (messageInput.value.length > maxChars) {
                        messageInput.value = messageInput.value.slice(0, maxChars);
                        alert(`You have reached the maximum char limit of ${maxChars}.`)
                    }
                });
                
                messageForm.addEventListener("submit", (event) => {
                    event.preventDefault();

                    const user_message = messageInput.value.trim();
                    const selectedFile = pdfFileInput.files[0];
                    const fileName = selectedFile ? selectedFile.name : undefined;
                    if (user_message.length === 0 && !selectedFile) return;

                    const messageItem_send = document.createElement("li");
                    messageItem_send.classList.add("message");
                    messageItem_send.innerHTML = `
                        <div class="avatar img-custom">
                            <img src="/images/user-avatar.png" width="30px" />
                        </div>
                        <div class="text sent">
                            <div class="message-sender">
                                <b>You</b>
                            </div>
                            <div class="message-content">
                                ${user_message}
                            </div>
                        </div>
                    `;

                    messagesList.appendChild(messageItem_send);

                    const messageItem_received = document.createElement("li");
                    messageItem_received.classList.add("message");
                    messageItem_received.innerHTML = `
                        <div class="avatar img-custom">
                            <img src="/images/aichatbot-avatar-2.png" width="30px" />
                        </div>
                        <div class="text received">
                            <div class="message-receiver">
                                <b>AI Chatbot</b>
                            </div>
                            <div class="message-content">
                                <div class="loader"></div>
                            </div>
                        </div>
                    `;

                    messagesList.appendChild(messageItem_received);

                    messagesList.scrollTop = messagesList.scrollHeight;
                    sendButton.disabled = true;

                    fetch("/", {
                        method: "POST",
                        body: new FormData(messageForm),
                    })
                    .then((response) => response.json())
                    .then((data) => {
                        const chatbot_message = data.message;
                        const messageItem_received = document.createElement("li");
                        messageItem_received.classList.add("message");
                        messageItem_received.innerHTML = `
                            <div class="avatar img-custom">
                                <img src="/images/aichatbot-avatar-2.png" width="30px" />
                            </div>
                            <div class="text received">
                                <div class="message-receiver">
                                    <b>AI Chatbot</b>
                                </div>
                                <div class="message-content">
                                    ${chatbot_message}
                                </div>
                            </div>
                        `;
                        if (messagesList.lastChild) {
                            messagesList.removeChild(messagesList.lastChild);
                        }
                        messagesList.appendChild(messageItem_received);
                        messagesList.scrollTop = messagesList.scrollHeight;
                        sendButton.disabled = false;

                    })
                    .catch((error) => {
                        const errorMessageItem = document.createElement("li");
                        errorMessageItem.classList.add("message");
                        errorMessageItem.innerHTML = `
                            <div class="avatar img-custom">
                                <img src="/images/aichatbot-avatar-2.png" width="30px" />
                            </div>
                            <div class="text received">
                                <div class="message-receiver">
                                    <b>AI Chatbot</b>
                                </div>
                                <div class="message-content">
                                    An error occurred while sending your message. Please try again.
                                </div>
                            </div>
                        `;

                        if (messagesList.lastChild) {
                            messagesList.removeChild(messagesList.lastChild);
                        }
                        messagesList.appendChild(errorMessageItem);
                        messagesList.scrollTop = messagesList.scrollHeight;
                        sendButton.disabled = false;
                    });

                    messageForm.reset();
                    messageInput.style.height = "1.8rem";
                    fileNameContainer.innerHTML = "";
                    messageInput.focus();
                });

                messageInput.focus();
                messagesList.scrollTop = messagesList.scrollHeight;
            }
        });
    </script>

</body>

</html>